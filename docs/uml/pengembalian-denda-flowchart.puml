@startuml
title Flowchart - Pengembalian Alat & Perhitungan Denda (eSarpra)

start
:Petugas membuka dashboard\n/ petugas;
:Pilih transaksi peminjaman;
:POST /petugas/kembali/:id;
:Load data peminjaman\n(+ user & alat);

if (Status disetujui/dipinjam?) then (Ya)
  :Input petugas:\nkondisi_pengembalian,\ncatatan_insiden,\nbiaya_insiden;
  :Update peminjaman:\nstatus = dikembalikan;\ntanggal_pengembalian = hari ini;

  if (Kondisi normal?) then (Ya)
    :Update alat:\nstok += jumlah;\nstatus = tersedia;
  else (Tidak)
    if (Kondisi rusak?) then (Ya)
      :Update alat:\nstatus = maintenance;\nkondisi = rusak_ringan/rusak_berat;
    else (Hilang)
      :Update alat:\nstok tidak ditambah kembali;
    endif
  endif

  :Hitung denda terlambat\n+ denda insiden;
  :Simpan denda:\ndenda_terlambat,\ndenda_insiden,\ndenda;
  if (Total denda > 0?) then (Ya)
    :Set status_pembayaran_denda = belum_bayar;
  else (Tidak)
    :Set status_pembayaran_denda = lunas;
  endif
  :LogAktivitas\n"Konfirmasi pengembalian...";
  :Redirect /petugas;
else (Tidak)
  :Tolak request\n"Status peminjaman tidak valid";
endif

stop
@enduml

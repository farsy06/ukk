@startuml
title Flowchart - Proses Login (eSarpra)

start
:User mengisi\nusername & password;
:POST /login;

if (User ditemukan?) then (Ya)
  if (User aktif?) then (Ya)
  :Validasi password\n(bcrypt compare);
  if (Password benar?) then (Ya)
    :Set session\nuserId & userRole;
    :Update last_login;
    if (Remember me?) then (Ya)
      :Generate remember token;\nSet cookie remember_token;
    else (Tidak)
      :Lewati remember token;
    endif
    :Redirect sesuai role\n(admin/petugas/peminjam);
  else (Tidak)
    :Flash error\n"Username atau password salah";
    :Tampilkan opsi\n"Lupa password?";
    if (Lupa password?) then (Ya)
      :GET /forgot-password;
      :Input username/email;
      :POST /forgot-password;
      :Generate reset token + expire;
      :Kirim email reset link;
      :Buka link /reset-password/:token;
      :Input password baru\n+ konfirmasi;
      :POST /reset-password/:token;
      if (Token valid & belum expired?) then (Ya)
        :Update password (bcrypt hash);\nclear reset token;
        :Flash sukses;
        :Redirect /login;
      else (Tidak)
        :Flash error\n"Token tidak valid/kedaluwarsa";
        :Redirect /forgot-password;
      endif
    else (Tidak)
      :Redirect /login;
    endif
  endif
  else (Tidak)
    :Flash error\n"Akun dinonaktifkan";
    :Redirect /login;
  endif
else (Tidak)
  :Flash error\n"Username atau password salah";
  :Tampilkan opsi\n"Lupa password?";
  if (Lupa password?) then (Ya)
    :GET /forgot-password;
    :Input username/email;
    :POST /forgot-password;
    :Generate reset token + expire;
    :Kirim email reset link;
    :Buka link /reset-password/:token;
    :Input password baru\n+ konfirmasi;
    :POST /reset-password/:token;
    if (Token valid & belum expired?) then (Ya)
      :Update password (bcrypt hash);\nclear reset token;
      :Flash sukses;
      :Redirect /login;
    else (Tidak)
      :Flash error\n"Token tidak valid/kedaluwarsa";
      :Redirect /forgot-password;
    endif
  else (Tidak)
    :Redirect /login;
  endif
endif

stop
@enduml

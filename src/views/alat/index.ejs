<style>
    .page-header {
        padding: 1.25rem 1.5rem;
        border-radius: 1rem;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.12), rgba(14, 165, 233, 0.12));
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-soft);
    }
    .filter-bar {
        padding: 1rem 1.25rem;
        border-radius: 1rem;
        background: var(--surface);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-soft);
    }
    .legend-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.65rem;
        border-radius: 999px;
        font-size: 0.75rem;
    }
    .alat-card {
        border-radius: 1rem;
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
    }
    .alat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 30px rgba(15, 23, 42, 0.18);
    }
    .alat-image {
        height: 200px;
        object-fit: cover;
    }
    .alat-empty {
        height: 200px;
        background: var(--surface-2);
        color: var(--muted-color);
    }
    .meta-stack small {
        display: block;
        margin-bottom: 0.35rem;
    }
    .pagination .page-link {
        border-radius: 0.65rem;
        margin: 0 0.1rem;
        border: 1px solid var(--border-color);
    }
    .pagination .page-item.active .page-link {
        background: var(--primary-color);
        border-color: transparent;
    }
</style>

<div class="row">
    <div class="col-12">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 page-header">
            <div>
                <h2 class="mb-1">Daftar Alat Tersedia</h2>
                <p class="text-muted mb-0">Cari, filter, dan ajukan peminjaman dengan cepat.</p>
            </div>
            <div class="text-end">
                <span class="badge bg-info-subtle text-info border border-info-subtle">
                    <i class="fas fa-box"></i> Total: <%= typeof range !== 'undefined' && range ? range.total : (alat ? alat.length : 0) %> alat
                </span>
            </div>
        </div>
    </div>
</div>

<% if (typeof pagination !== 'undefined' && pagination && pagination.totalPages > 1) { %>
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <% if (pagination.hasPrev) { %>
                    <li class="page-item">
                        <a class="page-link" href="/alat?page=<%= pagination.page - 1 %>" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                <% } else { %>
                    <li class="page-item disabled">
                        <span class="page-link">&laquo;</span>
                    </li>
                <% } %>

                <% const startPage = Math.max(1, pagination.page - 2); %>
                <% const endPage = Math.min(pagination.totalPages, pagination.page + 2); %>
                
                <% if (startPage > 1) { %>
                    <li class="page-item">
                        <a class="page-link" href="/alat?page=1">1</a>
                    </li>
                    <% if (startPage > 2) { %>
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    <% } %>
                <% } %>

                <% for (let i = startPage; i <= endPage; i++) { %>
                    <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
                        <% if (i === pagination.page) { %>
                            <span class="page-link"><%= i %></span>
                        <% } else { %>
                            <a class="page-link" href="/alat?page=<%= i %>"><%= i %></a>
                        <% } %>
                    </li>
                <% } %>

                <% if (endPage < pagination.totalPages) { %>
                    <% if (endPage < pagination.totalPages - 1) { %>
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    <% } %>
                    <li class="page-item">
                        <a class="page-link" href="/alat?page=<%= pagination.totalPages %>"><%= pagination.totalPages %></a>
                    </li>
                <% } %>

                <% if (pagination.hasNext) { %>
                    <li class="page-item">
                        <a class="page-link" href="/alat?page=<%= pagination.page + 1 %>" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                <% } else { %>
                    <li class="page-item disabled">
                        <span class="page-link">&raquo;</span>
                    </li>
                <% } %>
            </ul>
        </nav>
        <div class="text-center text-muted small mt-2">
            Menampilkan <%= typeof range !== 'undefined' && range ? range.start : 1 %> - <%= typeof range !== 'undefined' && range ? range.end : (alat ? alat.length : 0) %> dari <%= typeof range !== 'undefined' && range ? range.total : (alat ? alat.length : 0) %> alat
        </div>
    </div>
</div>
<% } %>

<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 filter-bar">
            <div class="d-flex flex-wrap gap-2">
                <div class="input-group" style="width: 280px;">
                    <input type="text" class="form-control" id="searchInput" placeholder="Cari alat...">
                    <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <select class="form-select" id="kategoriFilter" style="width: 220px;">
                    <option value="">Semua Kategori</option>
                    <% if (typeof kategori !== 'undefined' && kategori) { %>
                        <% kategori.forEach(function(kat) { %>
                            <option value="<%= kat.id %>"><%= kat.nama_kategori %></option>
                        <% }); %>
                    <% } %>
                </select>
            </div>
            <div>
                <span class="legend-badge bg-success-subtle text-success border border-success-subtle">
                    <i class="fas fa-check-circle"></i> Tersedia
                </span>
                <span class="legend-badge bg-warning-subtle text-warning border border-warning-subtle ms-2">
                    <i class="fas fa-exclamation-triangle"></i> Rusak Ringan
                </span>
                <span class="legend-badge bg-danger-subtle text-danger border border-danger-subtle ms-2">
                    <i class="fas fa-times-circle"></i> Rusak Berat
                </span>
            </div>
        </div>
    </div>
</div>

<div class="row" id="alatGrid">
    <% if (typeof alat !== 'undefined' && alat && alat.length > 0) { %>
        <% alat.forEach(function(item) { %>
            <div class="col-md-4 mb-4" data-id="<%= item.id %>" data-nama="<%= item.nama_alat %>" data-kategori="<%= item.kategori ? item.kategori.id : '' %>" data-kondisi="<%= item.kondisi %>" data-status="<%= item.status %>">
                <div class="card h-100 alat-card">
                    <div class="position-relative">
                        <% if (item.foto) { %>
                            <img src="<%= item.foto %>" alt="Foto Alat" class="card-img-top alat-image">
                        <% } else { %>
                            <div class="d-flex align-items-center justify-content-center alat-empty">
                                <i class="fas fa-camera fa-3x"></i>
                            </div>
                        <% } %>
                        <div class="position-absolute top-0 end-0 m-2">
                            <% if (item.status === 'tersedia') { %>
                                <span class="badge bg-success-subtle text-success border border-success-subtle">Tersedia</span>
                            <% } else if (item.status === 'dipinjam') { %>
                                <span class="badge bg-warning-subtle text-warning border border-warning-subtle">Dipinjam</span>
                            <% } else if (item.status === 'maintenance') { %>
                                <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">Maintenance</span>
                            <% } %>
                        </div>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">
                            <%= item.nama_alat %>
                            <% if (item.deskripsi) { %>
                                <i class="fas fa-info-circle text-muted ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="<%= item.deskripsi %>"></i>
                            <% } %>
                        </h5>
                        <div class="meta-stack">
                            <small class="text-muted">
                                <i class="fas fa-layer-group"></i>
                                Kategori: <%= item.kategori ? item.kategori.nama_kategori : 'Tidak ada kategori' %>
                            </small>
                            <small class="text-muted">
                                <i class="fas fa-box"></i>
                                Stok:
                                <span class="badge <%= item.stok > 5 ? 'bg-success-subtle text-success border border-success-subtle' : item.stok > 0 ? 'bg-warning-subtle text-warning border border-warning-subtle' : 'bg-danger-subtle text-danger border border-danger-subtle' %>">
                                    <%= item.stok %>
                                </span>
                            </small>
                            <small class="text-muted">
                                <i class="fas fa-heartbeat"></i>
                                Kondisi:
                                <% if (item.kondisi === 'baik') { %>
                                    <span class="badge bg-success-subtle text-success border border-success-subtle">
                                        <i class="fas fa-check-circle"></i> Baik
                                    </span>
                                <% } else if (item.kondisi === 'rusak_ringan') { %>
                                    <span class="badge bg-warning-subtle text-warning border border-warning-subtle">
                                        <i class="fas fa-exclamation-triangle"></i> Rusak Ringan
                                    </span>
                                <% } else if (item.kondisi === 'rusak_berat') { %>
                                    <span class="badge bg-danger-subtle text-danger border border-danger-subtle">
                                        <i class="fas fa-times-circle"></i> Rusak Berat
                                    </span>
                                <% } %>
                            </small>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-0">
                        <div class="d-grid">
                            <% if (item.status === 'tersedia' && item.stok > 0) { %>
                                <a href="/peminjaman/ajukan/<%= item.id %>" class="btn btn-primary">
                                    <i class="fas fa-hand-holding"></i> Ajukan Peminjaman
                                </a>
                            <% } else if (item.status === 'maintenance') { %>
                                <button class="btn btn-outline-secondary" disabled>
                                    <i class="fas fa-wrench"></i> Sedang Maintenance
                                </button>
                            <% } else if (item.stok === 0) { %>
                                <button class="btn btn-outline-warning" disabled>
                                    <i class="fas fa-exclamation-triangle"></i> Stok Habis
                                </button>
                            <% } else { %>
                                <button class="btn btn-outline-info" disabled>
                                    <i class="fas fa-handshake"></i> Sedang Dipinjam
                                </button>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        <% }); %>
    <% } else { %>
        <div class="col-12">
            <div class="card alat-card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                    <h5 class="card-title text-muted">Tidak ada alat yang tersedia</h5>
                    <p class="card-text text-muted">Saat ini tidak ada alat yang tersedia untuk dipinjam.</p>
                    <a href="/alat" class="btn btn-primary">
                        <i class="fas fa-refresh"></i> Muat Ulang
                    </a>
                </div>
            </div>
        </div>
    <% } %>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card alat-card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Informasi Peminjaman</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-clock"></i> Peraturan Peminjaman</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success"></i> Maksimal peminjaman 7 hari</li>
                            <li><i class="fas fa-check text-success"></i> Harap periksa kondisi alat sebelum meminjam</li>
                            <li><i class="fas fa-check text-success"></i> Kembalikan alat dalam kondisi baik</li>
                            <li><i class="fas fa-check text-success"></i> Denda keterlambatan: Rp <%= overdueFinePerDayFormatted %>/hari</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-shield-alt"></i> Kondisi Alat</h6>
                        <ul class="list-unstyled">
                            <li><span class="badge bg-success-subtle text-success border border-success-subtle"><i class="fas fa-check-circle"></i> Baik</span> - Alat dalam kondisi sempurna</li>
                            <li><span class="badge bg-warning-subtle text-warning border border-warning-subtle"><i class="fas fa-exclamation-triangle"></i> Rusak Ringan</span> - Masih dapat digunakan</li>
                            <li><span class="badge bg-danger-subtle text-danger border border-danger-subtle"><i class="fas fa-times-circle"></i> Rusak Berat</span> - Tidak dapat digunakan</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const clearSearch = document.getElementById('clearSearch');
        const kategoriFilter = document.getElementById('kategoriFilter');
        const alatGrid = document.getElementById('alatGrid');
        const cards = alatGrid.querySelectorAll('.col-md-4');

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Search functionality
        if (searchInput) {
            searchInput.addEventListener('input', filterAlat);
        }

        // Clear search functionality
        if (clearSearch) {
            clearSearch.addEventListener('click', function() {
                searchInput.value = '';
                kategoriFilter.value = '';
                filterAlat();
            });
        }

        // Category filter functionality
        if (kategoriFilter) {
            kategoriFilter.addEventListener('change', filterAlat);
        }

        function filterAlat() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedKategori = kategoriFilter.value;

            cards.forEach(card => {
                const nama = card.getAttribute('data-nama').toLowerCase();
                const kategori = card.getAttribute('data-kategori');
                const kondisi = card.getAttribute('data-kondisi');
                const status = card.getAttribute('data-status');
                
                const matchesSearch = nama.includes(searchTerm);
                const matchesKategori = !selectedKategori || kategori === selectedKategori;
                
                const matches = matchesSearch && matchesKategori;
                
                card.style.display = matches ? '' : 'none';
            });
        }

        // Add keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && searchInput.value) {
                searchInput.value = '';
                kategoriFilter.value = '';
                filterAlat();
            }
        });

        // Add loading state for buttons
        const actionButtons = document.querySelectorAll('.btn-primary');
        actionButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
                this.disabled = true;
                
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.disabled = false;
                }, 1000);
            });
        });
    });
</script>

<%
    const parsedPeminjaman = (() => {
        if (typeof peminjaman === 'string') {
            try {
                return JSON.parse(peminjaman);
            } catch (_err) {
                return [];
            }
        }
        return peminjaman;
    })();
    const peminjamanList = Array.isArray(parsedPeminjaman)
        ? parsedPeminjaman
        : (parsedPeminjaman && Array.isArray(parsedPeminjaman.rows))
            ? parsedPeminjaman.rows
            : [];
    const normalizeStatus = (status) =>
        typeof status === 'string' ? status.toLowerCase().trim() : '';
    const paymentStatusLabel = (status) => {
        if (status === 'lunas') return { className: 'bg-success', text: 'Lunas' };
        if (status === 'menunggu_verifikasi') return { className: 'bg-info', text: 'Menunggu Verifikasi' };
        if (status === 'ditolak') return { className: 'bg-danger', text: 'Bukti Ditolak' };
        return { className: 'bg-warning text-dark', text: 'Belum Bayar' };
    };

    const pendingCount = peminjamanList.filter(p => normalizeStatus(p.status) === 'pending').length;
    const inProgressCount = peminjamanList.filter(p => ['disetujui', 'dipinjam'].includes(normalizeStatus(p.status))).length;
    const doneCount = peminjamanList.filter(p => normalizeStatus(p.status) === 'dikembalikan').length;
    const overdueCount = peminjamanList.filter(p => {
        const overdue = typeof p.isOverdue === 'function' ? p.isOverdue() : !!p.is_overdue;
        return overdue && ['disetujui', 'dipinjam'].includes(normalizeStatus(p.status));
    }).length;

    const alatMap = new Map();
    peminjamanList.forEach(item => {
        if (item.alat && item.alat.id) {
            alatMap.set(item.alat.id, item.alat);
        }
    });
    const trackedAlat = Array.from(alatMap.values());
    const trackedAlatCount = trackedAlat.length;
    const totalStokTerlihat = trackedAlat.reduce((sum, alatItem) => sum + (Number(alatItem.stok) || 0), 0);
    const lowStockCount = trackedAlat.filter(alatItem => (Number(alatItem.stok) || 0) > 0 && (Number(alatItem.stok) || 0) <= 2).length;
    const emptyStockCount = trackedAlat.filter(alatItem => (Number(alatItem.stok) || 0) === 0).length;
    const totalCount = peminjamanList.length;
%>

<div class="row">
    <div class="col-12">
        <%- include('../_partials/page-head', {
            title: 'Dashboard Petugas',
            subtitle: 'Pantau pengajuan, stok alat, dan proses pengembalian.',
            actions: `<div class="text-end">
                <span class="badge bg-warning text-dark"><i class="fas fa-user-tie me-1"></i>Petugas</span>
            </div>`
        }) %>
    </div>
</div>

<div class="row mt-4 g-3">
    <div class="col-md-3">
        <div class="card table-card h-100">
            <div class="card-body">
                <small class="text-muted d-block">Menunggu</small>
                <h3 class="mb-0 text-warning"><%= pendingCount %></h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card table-card h-100">
            <div class="card-body">
                <small class="text-muted d-block">Sedang Berjalan</small>
                <h3 class="mb-0 text-primary"><%= inProgressCount %></h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card table-card h-100">
            <div class="card-body">
                <small class="text-muted d-block">Terlambat</small>
                <h3 class="mb-0 text-danger"><%= overdueCount %></h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card table-card h-100">
            <div class="card-body">
                <small class="text-muted d-block">Selesai</small>
                <h3 class="mb-0 text-success"><%= doneCount %></h3>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4 g-3">
    <div class="col-lg-8">
        <div class="card table-card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-list me-2"></i>Daftar Peminjaman</h6>
            </div>
            <div class="card-body">
                <div class="table-toolbar">
                    <div class="d-flex gap-2">
                        <div class="input-group" style="width: 300px;">
                            <input type="text" class="form-control" id="searchInput" placeholder="Cari peminjaman...">
                            <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <span class="badge bg-info">Total: <%= totalCount %></span>
                        <span class="badge bg-secondary">Alat: <%= trackedAlatCount %></span>
                    </div>
                </div>

                <table class="table table-striped table-hover" id="peminjamanTable">
                    <thead class="table-light">
                        <tr>
                            <th>No</th>
                            <th>Peminjam</th>
                            <th>Alat</th>
                            <th>Stok</th>
                            <th>Periode</th>
                            <th>Status</th>
                            <th>Denda</th>
                            <th class="table-actions">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (peminjamanList.length > 0) { %>
                            <% peminjamanList.forEach(function(item, index) { %>
                                <%
                                    const daysOverdue = typeof item.getDaysOverdue === 'function'
                                        ? item.getDaysOverdue()
                                        : (item.days_overdue || 0);
                                    const fineAmount = typeof item.calculateFine === 'function'
                                        ? item.calculateFine()
                                        : (item.fine_amount || 0);
                                    const paymentStatus = item.status_pembayaran_denda || 'belum_bayar';
                                    const paymentMeta = paymentStatusLabel(paymentStatus);
                                    const stokAlat = item.alat && typeof item.alat.stok !== 'undefined'
                                        ? Number(item.alat.stok) || 0
                                        : 0;
                                    const stokClass = stokAlat === 0
                                        ? 'bg-danger'
                                        : stokAlat <= 2
                                            ? 'bg-warning text-dark'
                                            : 'bg-success';
                                %>
                                <tr
                                    data-id="<%= item.id %>"
                                    data-peminjam="<%= item.user.nama %>"
                                    data-alat="<%= item.alat.nama_alat %>"
                                    data-status="<%= item.status %>"
                                    data-stok="<%= stokAlat %>"
                                >
                                    <td><%= index + 1 %></td>
                                    <td>
                                        <div class="fw-bold"><%= item.user.nama %></div>
                                        <small class="text-muted">@<%= item.user.username %></small>
                                    </td>
                                    <td>
                                        <div class="fw-bold"><%= item.alat.nama_alat %></div>
                                        <small class="text-muted">Jumlah pinjam: <%= item.jumlah || 1 %></small>
                                    </td>
                                    <td>
                                        <span class="badge <%= stokClass %>"><%= stokAlat %></span>
                                    </td>
                                    <td>
                                        <small class="d-block"><%= new Date(item.tanggal_pinjam).toLocaleDateString('id-ID') %></small>
                                        <small class="text-muted d-block"><%= new Date(item.tanggal_kembali).toLocaleDateString('id-ID') %></small>
                                    </td>
                                    <td>
                                        <% if (item.status === 'pending') { %>
                                            <span class="badge bg-warning text-dark">Menunggu</span>
                                        <% } else if (item.status === 'disetujui') { %>
                                            <span class="badge bg-info">Disetujui</span>
                                        <% } else if (item.status === 'dipinjam') { %>
                                            <span class="badge bg-primary">Dipinjam</span>
                                        <% } else if (item.status === 'dikembalikan') { %>
                                            <span class="badge bg-success">Dikembalikan</span>
                                        <% } else if (item.status === 'ditolak') { %>
                                            <span class="badge bg-danger">Ditolak</span>
                                        <% } else { %>
                                            <span class="badge bg-secondary"><%= item.status %></span>
                                        <% } %>
                                        <% if (item.kondisi_pengembalian && item.kondisi_pengembalian !== 'normal') { %>
                                            <small class="d-block mt-1 text-danger">
                                                Kondisi: <%= item.kondisi_pengembalian === 'rusak' ? 'Rusak' : 'Hilang' %>
                                            </small>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (fineAmount > 0) { %>
                                            <% if (daysOverdue > 0) { %>
                                                <span class="badge bg-danger"><%= daysOverdue %> hari</span>
                                            <% } else { %>
                                                <span class="badge bg-warning text-dark">Insiden</span>
                                            <% } %>
                                            <small class="d-block mt-1">Rp <%= new Intl.NumberFormat('id-ID').format(fineAmount) %></small>
                                            <% if (item.status === 'dikembalikan') { %>
                                                <span class="badge <%= paymentMeta.className %> mt-1"><%= paymentMeta.text %></span>
                                                <% if (item.bukti_pembayaran) { %>
                                                    <a href="<%= item.bukti_pembayaran %>" target="_blank" class="d-block small mt-1">Lihat bukti</a>
                                                <% } %>
                                                <% if (item.catatan_verifikasi_denda) { %>
                                                    <small class="d-block text-muted mt-1"><%= item.catatan_verifikasi_denda %></small>
                                                <% } %>
                                            <% } %>
                                        <% } else { %>
                                            <span class="text-muted">-</span>
                                        <% } %>
                                    </td>
                                    <td class="table-actions">
                                        <div class="btn-group-vertical" role="group">
                                            <% if (item.status === 'pending') { %>
                                                <form action="/petugas/setujui/<%= item.id %>" method="post" class="d-inline" data-confirm="Setujui peminjaman ini?">
                                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                    <button type="submit" class="btn btn-sm btn-success">Setujui</button>
                                                </form>
                                                <form action="/petugas/tolak/<%= item.id %>" method="post" class="d-inline" data-confirm="Tolak peminjaman ini?">
                                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                    <button type="submit" class="btn btn-sm btn-danger">Tolak</button>
                                                </form>
                                            <% } else if (item.status === 'disetujui' || item.status === 'dipinjam') { %>
                                                <button
                                                    type="button"
                                                    class="btn btn-sm btn-info open-return-modal"
                                                    data-id="<%= item.id %>"
                                                    data-item-name="<%= item.alat.nama_alat %>"
                                                    data-user-name="<%= item.user.nama %>"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#returnItemModal"
                                                >
                                                    Kembalikan
                                                </button>
                                            <% } else if (item.status === 'dikembalikan' && fineAmount > 0 && item.status_pembayaran_denda === 'menunggu_verifikasi') { %>
                                                <form action="/petugas/denda/verifikasi/<%= item.id %>" method="post" class="d-inline" data-confirm="Verifikasi pembayaran denda ini?">
                                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                    <button type="submit" class="btn btn-sm btn-success">Verifikasi</button>
                                                </form>
                                                <form action="/petugas/denda/tolak/<%= item.id %>" method="post" class="d-inline" data-confirm="Tolak bukti pembayaran ini?">
                                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger">Tolak</button>
                                                </form>
                                            <% } else if (item.status === 'dikembalikan' && fineAmount > 0 && item.status_pembayaran_denda !== 'lunas') { %>
                                                <button
                                                    type="button"
                                                    class="btn btn-sm btn-outline-success open-cash-modal"
                                                    data-id="<%= item.id %>"
                                                    data-item-name="<%= item.alat.nama_alat %>"
                                                    data-user-name="<%= item.user.nama %>"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#cashPaymentModal"
                                                >
                                                    Bayar Tunai
                                                </button>
                                            <% } else { %>
                                                <button class="btn btn-sm btn-secondary" disabled>Selesai</button>
                                            <% } %>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <div class="alert alert-info mb-0">
                                        Tidak ada peminjaman yang perlu diproses.
                                    </div>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card table-card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-boxes-stacked me-2"></i>Ringkasan Stok</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Total alat terpantau</span>
                    <strong><%= trackedAlatCount %></strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Total stok terlihat</span>
                    <strong><%= totalStokTerlihat %></strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Stok menipis (<=2)</span>
                    <strong class="text-warning"><%= lowStockCount %></strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="text-muted">Stok habis</span>
                    <strong class="text-danger"><%= emptyStockCount %></strong>
                </div>
            </div>
        </div>

        <div class="card table-card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Laporan</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/laporan" class="btn btn-outline-primary">
                        <i class="fas fa-chart-line me-1"></i> Ringkasan Laporan
                    </a>
                    <a href="/laporan/peminjaman" class="btn btn-outline-info">
                        <i class="fas fa-hand-holding me-1"></i> Laporan Peminjaman
                    </a>
                    <a href="/laporan/alat" class="btn btn-outline-success">
                        <i class="fas fa-tools me-1"></i> Laporan Alat
                    </a>
                    <a href="/laporan/aktivitas" class="btn btn-outline-secondary">
                        <i class="fas fa-history me-1"></i> Laporan Aktivitas
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="returnItemModal" tabindex="-1" aria-labelledby="returnItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="returnItemForm" method="post" action="#">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <div class="modal-header">
                    <h5 class="modal-title" id="returnItemModalLabel">Konfirmasi Pengembalian</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">
                        Alat <strong id="returnItemName">-</strong> oleh <strong id="returnUserName">-</strong>.
                    </p>
                    <div class="mb-3">
                        <label for="kondisi_pengembalian" class="form-label">Kondisi</label>
                        <select class="form-select" name="kondisi_pengembalian" id="kondisi_pengembalian">
                            <option value="normal">Normal</option>
                            <option value="rusak">Rusak</option>
                            <option value="hilang">Hilang</option>
                        </select>
                    </div>
                    <div id="incidentFields" class="d-none">
                        <div class="mb-3">
                            <label for="biaya_insiden" class="form-label">Biaya Insiden (Rp)</label>
                            <input type="number" min="0" step="1000" class="form-control" name="biaya_insiden" id="biaya_insiden" placeholder="0">
                        </div>
                        <div>
                            <label for="catatan_insiden" class="form-label">Catatan Insiden</label>
                            <textarea class="form-control" name="catatan_insiden" id="catatan_insiden" rows="3" placeholder="Jelaskan kerusakan/kehilangan"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-info" id="submitReturnItem">Konfirmasi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="cashPaymentModal" tabindex="-1" aria-labelledby="cashPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="cashPaymentForm" method="post" action="#">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <div class="modal-header">
                    <h5 class="modal-title" id="cashPaymentModalLabel">Konfirmasi Pembayaran Tunai</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">
                        Catat pelunasan tunai untuk <strong id="cashItemName">-</strong> oleh <strong id="cashUserName">-</strong>.
                    </p>
                    <div>
                        <label for="cashPaymentNote" class="form-label">Catatan Pembayaran Tunai</label>
                        <textarea
                            class="form-control"
                            name="catatan_verifikasi_denda"
                            id="cashPaymentNote"
                            rows="3"
                            placeholder="Contoh: Bayar tunai di loket pada 12 Feb 2026"
                            required
                        ></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-success" id="submitCashPayment">Tandai Lunas</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const clearSearch = document.getElementById('clearSearch');
        const table = document.getElementById('peminjamanTable');
        const rows = table ? table.querySelectorAll('tbody tr') : [];
        const returnItemForm = document.getElementById('returnItemForm');
        const returnItemName = document.getElementById('returnItemName');
        const returnUserName = document.getElementById('returnUserName');
        const returnCondition = document.getElementById('kondisi_pengembalian');
        const incidentFields = document.getElementById('incidentFields');
        const incidentCost = document.getElementById('biaya_insiden');
        const incidentNotes = document.getElementById('catatan_insiden');
        const returnSubmit = document.getElementById('submitReturnItem');
        const cashPaymentForm = document.getElementById('cashPaymentForm');
        const cashItemName = document.getElementById('cashItemName');
        const cashUserName = document.getElementById('cashUserName');
        const cashPaymentNote = document.getElementById('cashPaymentNote');
        const submitCashPayment = document.getElementById('submitCashPayment');

        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                rows.forEach(row => {
                    const peminjam = (row.getAttribute('data-peminjam') || '').toLowerCase();
                    const alat = (row.getAttribute('data-alat') || '').toLowerCase();
                    const status = (row.getAttribute('data-status') || '').toLowerCase();
                    const stok = (row.getAttribute('data-stok') || '').toLowerCase();
                    const matches = peminjam.includes(searchTerm) || alat.includes(searchTerm) || status.includes(searchTerm) || stok.includes(searchTerm);
                    row.style.display = matches ? '' : 'none';
                });
            });
        }

        if (clearSearch && searchInput) {
            clearSearch.addEventListener('click', function() {
                searchInput.value = '';
                searchInput.dispatchEvent(new Event('input'));
            });
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && searchInput && searchInput.value) {
                searchInput.value = '';
                searchInput.dispatchEvent(new Event('input'));
            }
        });

        const actionForms = document.querySelectorAll('.btn-group-vertical form');
        actionForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                const message = this.getAttribute('data-confirm');
                if (message && !confirm(message)) {
                    e.preventDefault();
                }
            });
        });

        const returnTriggers = document.querySelectorAll('.open-return-modal');
        returnTriggers.forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const itemName = this.getAttribute('data-item-name') || '-';
                const userName = this.getAttribute('data-user-name') || '-';
                if (returnItemForm) returnItemForm.setAttribute('action', `/petugas/kembali/${id}`);
                if (returnItemName) returnItemName.textContent = itemName;
                if (returnUserName) returnUserName.textContent = userName;
                if (returnCondition) returnCondition.value = 'normal';
                if (incidentCost) incidentCost.value = '';
                if (incidentNotes) {
                    incidentNotes.value = '';
                    incidentNotes.required = false;
                }
                if (incidentFields) incidentFields.classList.add('d-none');
            });
        });

        const cashTriggers = document.querySelectorAll('.open-cash-modal');
        cashTriggers.forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const itemName = this.getAttribute('data-item-name') || '-';
                const userName = this.getAttribute('data-user-name') || '-';
                if (cashPaymentForm) cashPaymentForm.setAttribute('action', `/petugas/denda/cash/${id}`);
                if (cashItemName) cashItemName.textContent = itemName;
                if (cashUserName) cashUserName.textContent = userName;
                if (cashPaymentNote) cashPaymentNote.value = '';
            });
        });

        if (returnCondition) {
            returnCondition.addEventListener('change', function() {
                const isIncident = this.value !== 'normal';
                if (incidentFields) incidentFields.classList.toggle('d-none', !isIncident);
                if (incidentNotes) incidentNotes.required = isIncident;
            });
        }

        if (returnItemForm) {
            returnItemForm.addEventListener('submit', function(e) {
                if (!confirm('Konfirmasi pengembalian ini?')) {
                    e.preventDefault();
                    return;
                }
                if (returnSubmit) {
                    returnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
                    returnSubmit.disabled = true;
                }
            });
        }

        if (cashPaymentForm) {
            cashPaymentForm.addEventListener('submit', function(e) {
                if (!confirm('Konfirmasi pembayaran tunai dan tandai lunas?')) {
                    e.preventDefault();
                    return;
                }
                if (submitCashPayment) {
                    submitCashPayment.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
                    submitCashPayment.disabled = true;
                }
            });
        }
    });
</script>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-edit"></i> Edit Alat</h4>
            </div>
            <div class="card-body">
                <% if (typeof error !== 'undefined' && error) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <%= error %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>

                <form action="/admin/alat/edit/<%= alat.id %>" method="POST" id="alatEditForm">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nama_alat" class="form-label">Nama Alat <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="nama_alat" name="nama_alat" value="<%= alat.nama_alat %>" required>
                                <div class="form-text">Masukkan nama alat yang akan ditambahkan</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="kategori_id" class="form-label">Kategori <span class="text-danger">*</span></label>
                                <select class="form-select" id="kategori_id" name="kategori_id" required>
                                    <option value="">Pilih Kategori</option>
                                    <% if (typeof kategori !== 'undefined' && kategori) { %>
                                        <% kategori.forEach(function(kat) { %>
                                            <option value="<%= kat.id %>" <%= alat.kategori_id == kat.id ? 'selected' : '' %>><%= kat.nama_kategori %></option>
                                        <% }); %>
                                    <% } %>
                                </select>
                                <div class="form-text">Pilih kategori alat</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stok" class="form-label">Stok <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="stok" name="stok" value="<%= alat.stok %>" min="1" required>
                                <div class="form-text">Masukkan jumlah stok alat yang tersedia</div>
                            </div>
                            <div class="mb-3">
                                <label for="kondisi" class="form-label">Kondisi <span class="text-danger">*</span></label>
                                <select class="form-select" id="kondisi" name="kondisi" required>
                                    <option value="baik" <%= alat.kondisi === 'baik' ? 'selected' : '' %>>Baik</option>
                                    <option value="rusak_ringan" <%= alat.kondisi === 'rusak_ringan' ? 'selected' : '' %>>Rusak Ringan</option>
                                    <option value="rusak_berat" <%= alat.kondisi === 'rusak_berat' ? 'selected' : '' %>>Rusak Berat</option>
                                </select>
                                <div class="form-text">Pilih kondisi alat</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
                                <select class="form-select" id="status" name="status" required>
                                    <option value="tersedia" <%= alat.status === 'tersedia' ? 'selected' : '' %>>Tersedia</option>
                                    <option value="dipinjam" <%= alat.status === 'dipinjam' ? 'selected' : '' %>>Dipinjam</option>
                                    <option value="maintenance" <%= alat.status === 'maintenance' ? 'selected' : '' %>>Maintenance</option>
                                </select>
                                <div class="form-text">Pilih status alat</div>
                            </div>
                            <div class="mb-3">
                                <label for="deskripsi" class="form-label">Deskripsi</label>
                                <textarea class="form-control" id="deskripsi" name="deskripsi" rows="3" placeholder="Deskripsi alat (opsional)"><%= alat.deskripsi || '' %></textarea>
                                <div class="form-text">Masukkan deskripsi alat jika diperlukan</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="foto" class="form-label">Foto Alat</label>
                                <input type="file" class="form-control" id="foto" name="foto" accept="image/*">
                                <div class="form-text">Unggah foto alat baru (opsional)</div>
                                <% if (alat.foto) { %>
                                    <div class="mt-2">
                                        <img src="<%= alat.foto %>" alt="Foto Alat" class="img-thumbnail" style="max-width: 200px;">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="hapus_foto" name="hapus_foto">
                                            <label class="form-check-label" for="hapus_foto">
                                                Hapus foto saat ini
                                            </label>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="/admin/alat" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Kembali
                        </a>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Update Alat
                            </button>
                            <a href="/admin/alat/hapus/<%= alat.id %>" class="btn btn-danger ms-2" onclick="return confirm('Yakin ingin menghapus alat ini?')">
                                <i class="fas fa-trash"></i> Hapus
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('alatEditForm');
        const namaAlat = document.getElementById('nama_alat');
        const stok = document.getElementById('stok');
        const kondisi = document.getElementById('kondisi');
        const status = document.getElementById('status');

        // Form validation
        form.addEventListener('submit', function(e) {
            let isValid = true;
            const errors = [];

            // Validate nama alat
            if (namaAlat.value.trim().length < 3) {
                errors.push('Nama alat minimal 3 karakter');
                isValid = false;
            }

            // Validate stok
            if (parseInt(stok.value) < 1) {
                errors.push('Stok minimal 1');
                isValid = false;
            }

            // Show errors if any
            if (!isValid) {
                e.preventDefault();
                const errorHtml = errors.map(err => `<div><i class="fas fa-exclamation-circle"></i> ${err}</div>`).join('');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger alert-dismissible fade show';
                errorDiv.innerHTML = errorHtml + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
                
                // Remove existing error messages
                const existingErrors = document.querySelectorAll('.alert-danger');
                existingErrors.forEach(err => err.remove());
                
                form.insertBefore(errorDiv, form.firstChild);
            }
        });

        // Real-time validation for nama alat
        namaAlat.addEventListener('input', function() {
            if (this.value.trim().length < 3 && this.value.trim().length > 0) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });

        // Real-time validation for stok
        stok.addEventListener('input', function() {
            if (parseInt(this.value) < 1 && this.value !== '') {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });

        // Logic validation: if kondisi is rusak_berat, status should be maintenance
        kondisi.addEventListener('change', function() {
            if (this.value === 'rusak_berat' && status.value !== 'maintenance') {
                status.value = 'maintenance';
                const alert = document.createElement('div');
                alert.className = 'alert alert-warning alert-dismissible fade show';
                alert.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Alat dengan kondisi rusak berat harus berstatus maintenance <button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
                form.insertBefore(alert, form.firstChild);
            }
        });

        // Logic validation: if status is dipinjam, kondisi should not be rusak_berat
        status.addEventListener('change', function() {
            if (this.value === 'dipinjam' && kondisi.value === 'rusak_berat') {
                kondisi.value = 'rusak_ringan';
                const alert = document.createElement('div');
                alert.className = 'alert alert-warning alert-dismissible fade show';
                alert.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Alat dengan kondisi rusak berat tidak dapat dipinjam <button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
                form.insertBefore(alert, form.firstChild);
            }
        });
    });
</script>

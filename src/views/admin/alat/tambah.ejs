<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-plus"></i> Tambah Alat</h4>
            </div>
            <div class="card-body">
                <!-- Flash Messages -->
                <% if (typeof error !== 'undefined' && error && error.length > 0) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <% if (Array.isArray(error)) { %>
                            <% error.forEach(function(err) { %>
                                <div><i class="fas fa-exclamation-circle"></i> <%= err %></div>
                            <% }); %>
                        <% } else { %>
                            <i class="fas fa-exclamation-circle"></i> <%= error %>
                        <% } %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>

                <form action="/admin/alat/tambah" method="POST" id="alatForm" enctype="multipart/form-data">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nama_alat" class="form-label">Nama Alat <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="nama_alat" name="nama_alat" required>
                                <div class="form-text">Masukkan nama alat yang akan ditambahkan</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="kategori_id" class="form-label">Kategori <span class="text-danger">*</span></label>
                                <select class="form-select" id="kategori_id" name="kategori_id" required>
                                    <option value="">Pilih Kategori</option>
                                    <% if (typeof kategori !== 'undefined' && kategori) { %>
                                        <% kategori.forEach(function(kat) { %>
                                            <option value="<%= kat.id %>"><%= kat.nama_kategori %></option>
                                        <% }); %>
                                    <% } %>
                                </select>
                                <div class="form-text">Pilih kategori alat</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stok" class="form-label">Stok <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="stok" name="stok" value="1" min="1" required>
                                <div class="form-text">Masukkan jumlah stok alat yang tersedia</div>
                            </div>
                            <div class="mb-3">
                                <label for="kondisi" class="form-label">Kondisi <span class="text-danger">*</span></label>
                                <select class="form-select" id="kondisi" name="kondisi" required>
                                    <option value="baik">Baik</option>
                                    <option value="rusak_ringan">Rusak Ringan</option>
                                    <option value="rusak_berat">Rusak Berat</option>
                                </select>
                                <div class="form-text">Pilih kondisi alat</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
                                <select class="form-select" id="status" name="status" required>
                                    <option value="tersedia">Tersedia</option>
                                    <option value="maintenance">Maintenance</option>
                                </select>
                                <div class="form-text">Pilih status alat</div>
                            </div>
                            <div class="mb-3">
                                <label for="deskripsi" class="form-label">Deskripsi</label>
                                <textarea class="form-control" id="deskripsi" name="deskripsi" rows="3" placeholder="Deskripsi alat (opsional)"></textarea>
                                <div class="form-text">Masukkan deskripsi alat jika diperlukan</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="foto" class="form-label">Foto Alat</label>
                                <input type="file" class="form-control" id="foto" name="foto" accept="image/*">
                                <div class="form-text">Unggah foto alat (opsional)</div>
                                <div id="fotoError" class="text-danger small mt-1"></div>
                                <div class="mt-2">
                                    <img id="fotoPreview" src="" alt="Preview Foto" class="img-thumbnail" style="max-width: 200px; display: none;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="/admin/alat" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Kembali
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Simpan Alat
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('alatForm');
        const namaAlat = document.getElementById('nama_alat');
        const stok = document.getElementById('stok');
        const kondisi = document.getElementById('kondisi');
        const status = document.getElementById('status');
        const foto = document.getElementById('foto');
        const fotoPreview = document.getElementById('fotoPreview');
        const fotoError = document.getElementById('fotoError');
        const maxFotoSize = 2 * 1024 * 1024;
        const allowedFotoTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];

        const resetFotoError = () => {
            if (fotoError) fotoError.textContent = '';
            if (foto) foto.classList.remove('is-invalid');
        };

        const showFotoError = (message) => {
            if (fotoError) fotoError.textContent = message;
            if (foto) foto.classList.add('is-invalid');
        };

        const updateFotoPreview = (file) => {
            if (!fotoPreview) return;
            if (!file) {
                fotoPreview.src = '';
                fotoPreview.style.display = 'none';
                return;
            }
            fotoPreview.src = URL.createObjectURL(file);
            fotoPreview.style.display = 'block';
        };

        if (foto) {
            foto.addEventListener('change', function() {
                resetFotoError();
                const file = this.files && this.files[0];
                if (!file) {
                    updateFotoPreview(null);
                    return;
                }
                if (!allowedFotoTypes.includes(file.type)) {
                    showFotoError('Format foto tidak valid. Gunakan JPG, PNG, WEBP, atau GIF.');
                    this.value = '';
                    updateFotoPreview(null);
                    return;
                }
                if (file.size > maxFotoSize) {
                    showFotoError('Ukuran foto maksimal 2MB.');
                    this.value = '';
                    updateFotoPreview(null);
                    return;
                }
                updateFotoPreview(file);
            });
        }

        // Form validation
        form.addEventListener('submit', function(e) {
            let isValid = true;
            const errors = [];

            // Validate nama alat
            if (namaAlat.value.trim().length < 3) {
                errors.push('Nama alat minimal 3 karakter');
                isValid = false;
            }

            // Validate stok
            if (parseInt(stok.value) < 1) {
                errors.push('Stok minimal 1');
                isValid = false;
            }

            // Validate foto
            if (foto && foto.files && foto.files[0]) {
                const file = foto.files[0];
                if (!allowedFotoTypes.includes(file.type)) {
                    errors.push('Format foto tidak valid. Gunakan JPG, PNG, WEBP, atau GIF.');
                    showFotoError('Format foto tidak valid. Gunakan JPG, PNG, WEBP, atau GIF.');
                    isValid = false;
                } else if (file.size > maxFotoSize) {
                    errors.push('Ukuran foto maksimal 2MB.');
                    showFotoError('Ukuran foto maksimal 2MB.');
                    isValid = false;
                } else {
                    resetFotoError();
                }
            }

            // Show errors if any
            if (!isValid) {
                e.preventDefault();
                const errorHtml = errors.map(err => `<div><i class="fas fa-exclamation-circle"></i> ${err}</div>`).join('');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger alert-dismissible fade show';
                errorDiv.innerHTML = errorHtml + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
                
                // Remove existing error messages
                const existingErrors = document.querySelectorAll('.alert-danger');
                existingErrors.forEach(err => err.remove());
                
                form.insertBefore(errorDiv, form.firstChild);
            }
        });

        // Real-time validation for nama alat
        namaAlat.addEventListener('input', function() {
            if (this.value.trim().length < 3 && this.value.trim().length > 0) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });

        // Real-time validation for stok
        stok.addEventListener('input', function() {
            if (parseInt(this.value) < 1 && this.value !== '') {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });

        // Logic validation: if kondisi is rusak_berat, status should be maintenance
        kondisi.addEventListener('change', function() {
            if (this.value === 'rusak_berat' && status.value !== 'maintenance') {
                status.value = 'maintenance';
                const alert = document.createElement('div');
                alert.className = 'alert alert-warning alert-dismissible fade show';
                alert.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Alat dengan kondisi rusak berat harus berstatus maintenance <button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
                form.insertBefore(alert, form.firstChild);
            }
        });
    });
</script>

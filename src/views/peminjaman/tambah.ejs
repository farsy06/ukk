<section class="row">
    <div class="col-12">
        <%- include('../_partials/page-head', {
            title: 'Ajukan Peminjaman',
            subtitle: 'Lengkapi tanggal dan jumlah peminjaman berdasarkan ketersediaan alat.',
            actions: '<a href="/alat" class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> Kembali ke Daftar</a>'
        }) %>
    </div>
</section>

<section class="row g-4 mt-1">
    <div class="col-lg-5">
        <article class="peminjam-detail-card h-100">
            <div class="peminjam-detail-media mb-3">
                <% if (alat && alat.foto) { %>
                    <img src="<%= alat.foto %>" alt="Foto <%= alat.nama_alat %>" class="img-fluid rounded peminjam-detail-image">
                <% } else { %>
                    <div class="peminjam-detail-placeholder">
                        <i class="fas fa-camera"></i>
                    </div>
                <% } %>
            </div>

            <h5 class="mb-1"><%= alat ? alat.nama_alat : 'Alat tidak ditemukan' %></h5>
            <p class="text-muted small mb-3">
                <i class="fas fa-layer-group me-1"></i>
                <%= alat && alat.kategori ? alat.kategori.nama_kategori : 'Tanpa kategori' %>
            </p>

            <div class="d-flex flex-wrap gap-2 mb-3">
                <span class="badge <%= alat && alat.stok > 0 ? 'bg-success-subtle text-success border border-success-subtle' : 'bg-danger-subtle text-danger border border-danger-subtle' %>">
                    Stok: <%= alat ? alat.stok : 0 %>
                </span>
                <% if (alat && alat.kondisi === 'baik') { %>
                    <span class="badge bg-success-subtle text-success border border-success-subtle">Baik</span>
                <% } else if (alat && alat.kondisi === 'rusak_ringan') { %>
                    <span class="badge bg-warning-subtle text-warning border border-warning-subtle">Rusak Ringan</span>
                <% } else if (alat) { %>
                    <span class="badge bg-danger-subtle text-danger border border-danger-subtle">Rusak Berat</span>
                <% } %>
            </div>

            <% if (alat && alat.deskripsi) { %>
                <p class="small text-muted mb-0"><%= alat.deskripsi %></p>
            <% } %>
        </article>
    </div>

    <div class="col-lg-7">
        <div class="card">
            <div class="card-body p-4">
                <% const errorList = Array.isArray(error) ? error : (error ? [error] : []); %>
                <% if (errorList.length) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <% errorList.forEach((msg) => { %>
                            <div><i class="fas fa-circle-exclamation me-1"></i><%= msg %></div>
                        <% }); %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Tutup"></button>
                    </div>
                <% } %>

                <form action="/peminjaman/ajukan" method="POST" id="peminjamanForm" data-max-stok="<%= alat ? alat.stok : 1 %>" data-max-duration-days="7" novalidate>
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <% if (alat) { %>
                        <input type="hidden" name="alat_id" value="<%= alat.id %>">
                    <% } %>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="tanggal_pinjam" class="form-label">Tanggal Pinjam <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="tanggal_pinjam" name="tanggal_pinjam" required>
                        </div>
                        <div class="col-md-6">
                            <label for="tanggal_kembali" class="form-label">Tanggal Kembali <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="tanggal_kembali" name="tanggal_kembali" required>
                        </div>
                        <div class="col-md-6">
                            <label for="jumlah" class="form-label">Jumlah <span class="text-danger">*</span></label>
                            <input
                                type="number"
                                class="form-control"
                                id="jumlah"
                                name="jumlah"
                                min="1"
                                max="<%= alat ? alat.stok : 1 %>"
                                value="1"
                                required
                            >
                        </div>
                        <div class="col-12">
                            <label for="catatan" class="form-label">Catatan (Opsional)</label>
                            <textarea class="form-control" id="catatan" name="catatan" rows="4" placeholder="Contoh: Untuk praktikum kelas XI IPA..."></textarea>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3 mb-4 peminjam-rule-box">
                        <strong><i class="fas fa-circle-info me-1"></i>Peraturan:</strong>
                        <ul class="mb-0 mt-2 ps-3">
                            <li>Maksimal durasi peminjaman 7 hari.</li>
                            <li>Denda keterlambatan Rp <%= overdueFinePerDayFormatted %> per hari.</li>
                            <li>Pengajuan dapat dibatalkan selama status masih menunggu.</li>
                        </ul>
                    </div>

                    <div class="d-flex justify-content-end gap-2 flex-wrap">
                        <a href="/alat" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Kembali
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitPeminjamanBtn">
                            <i class="fas fa-paper-plane me-1"></i>Ajukan Peminjaman
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<script src="/js/peminjaman-tambah.js"></script>
